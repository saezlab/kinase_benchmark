from snakemake.utils import min_version
min_version("6.0")
import os

configfile: "config/config.yml"


# ------------------------------------ Default setting ------------------------------------
rule all:
    input:
        expand("results/activity_scores/{PKN}/{dataset}_{PKN}.rds", dataset = config["activity_estimation"]["datasets"], PKN = config["activity_estimation"]["PKNs"])


# ------------------------------ Prior knowledge preparation ------------------------------
rule prepare_omnipath:
    input:
        file_dataset = expand("data/CPTAC_phospho/{dataset}_phospho_data_median_centered.tsv", dataset = config["activity_estimation"]["datasets"])
    output:
        tsv = "results/prior/omnipath.tsv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/01.1_prepare_omnipath.R"

rule prepare_phosphositeplus:
    input:
        ppsp = "data/prior/phosphositeplus",
        file_dataset = expand("data/CPTAC_phospho/{dataset}_phospho_data_median_centered.tsv", dataset = config["activity_estimation"]["datasets"])
    output:
        tsv = "results/prior/phosphositeplus.tsv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/01.2_prepare_phosphositeplus.R"

rule prepare_ptmsigdb:
    input:
        ptmsig_file = "data/prior/ptm.sig.db.all.uniprot.human.v1.9.0.gmt",
        file_dataset = expand("data/CPTAC_phospho/{dataset}_phospho_data_median_centered.tsv", dataset = config["activity_estimation"]["datasets"])
    output:
        tsv = "results/prior/ptmsigdb.tsv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/01.3_prepare_ptmsigdb.R"

rule prepare_ikipdb:
    input:
        ptmsig_file = "data/prior/iKiP-DB-Table.tsv",
        file_dataset = expand("data/CPTAC_phospho/{dataset}_phospho_data_median_centered.tsv", dataset = config["activity_estimation"]["datasets"])
    output:
        tsv = "results/prior/iKiPdb.tsv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/01.4_prepare_ikipdb.R"

rule prepare_GPS:
    input:
        GPS_file = "data/prior/mmc4.xlsx"
        file_dataset = expand("data/CPTAC_phospho/{dataset}_phospho_data_median_centered.tsv", dataset = config["activity_estimation"]["datasets"])
    output:
        tsv = "results/prior/GPS_goldStandard.tsv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/01.5_prepare_GPSgoldStandard.R"

rule prepare_NetworKIN:
    input:
        networkin_file = "data/prior/networkin_human_predictions_3.1.tsv"
        file_dataset = expand("data/CPTAC_phospho/{dataset}_phospho_data_median_centered.tsv", dataset = config["activity_estimation"]["datasets"])
        GPS_file = "results/prior/GPS_goldStandard.tsv"
        score = 5
    output:
        tsv = "results/prior/networkin.tsv"
        tsv_merge = "results/prior/GPS_NetworKIN.tsv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/01.6_prepare_NetworKIN.R"

rule map_kinase_ids:
    input:
        prior_files = expand("results/prior/{PKN}.tsv", PKN = config["activity_estimation"]["PKNs"])
    output:
        tsv = "resources/kinase_mapping.tsv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/02_convert_kinase_ids.R"


# ---------------------------------- Activity estimation ----------------------------------
rule activity_estimation:
    input:
        file_dataset = "data/CPTAC_phospho/{dataset}_phospho_data_median_centered.tsv",
        file_PKN = "results/prior/{PKN}.tsv",
        scripts = expand("workflow/scripts/methods/run_{method}.R", method = ["INKA", "KARP", "lm_rokai", "zscore"]),
        script_support = "workflow/scripts/methods/support_functions.R"
    output:
        rds = "results/activity_scores/{PKN}/{dataset}_{PKN}.rds"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/03_activity_estimation.R"


# -------------------------------------- Comparison ---------------------------------------
rule activity_comparison:
    input:
        act_files = expand("results/activity_scores/{PKN}/{dataset}_{PKN}.rds", PKN = config["activity_estimation"]["PKNs"], dataset = config["activity_estimation"]["datasets"]),
        jaccard_i = "10"
    output:
        plotSpearman = "results/comparison/plots/spearman_heatmap.pdf",
        plotPearson = "results/comparison/plots/pearson_heatmap.pdf",
        plotJaccardUp = "results/comparison/plots/jaccard_up_heatmap.pdf",
        plotJaccardDown = "results/comparison/plots/jaccard_down_heatmap.pdf",
        dist_csv = "results/comparison/mean_distance.csv"
    conda:
        "envs/phospho.yml"
    script:
        "scripts/04_compare_activities.R"

