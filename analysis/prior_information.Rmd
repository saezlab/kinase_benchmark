---
title: "Prior knowledge"
author: "Sophia MÃ¼ller-Dott"
date: '2022-08-30'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Here we will compare the amount of information from the pior knowledge network of the tools. The goal is to see for how many kinases we can estimate activities for each tool and how many phosphorylation sites can be considered in an optimal case. We will look at these methods:

- CLUE (PhosphoSitePlus)
PPS+
- IKAP
PPS+
- KinasePA
PPS+
- KARP
PPS+
- KSEA App
PPS+ + NetworKIN (score >= 5)
- INKA
- PTM-SEA
PTMsigDB
- KEA3
- RoKAI

```{r, warning=FALSE, message=FALSE}
library(ClueR) 
library(directPA)
library(KSEAapp)
library(qusage)

library(ggbreak)
library(patchwork)
library(tidyverse)

```

## Prior knowledge size

For each tool we will extract the number of interactions, unique kinases, kinases with at least 5 targets and unique pps.

### Clue
ClueR provides a package containing the data from PhosphoSitePlus which they use in their method. (This is not the most updated version see IKAP)

```{r}
data(PhosphoSite)
CLUe.network.human <- PhosphoSite.human
CLUe.size.human <- c(tool = "CLUe",
                     kinases = unique(names(CLUe.network.human)) %>% 
                       length(),
                     kinases_5 = names(CLUe.network.human)[map(CLUe.network.human, length) >= 5] %>% 
                       unique() %>%
                       length(),
                     pps = unlist(CLUe.network.human) %>% 
                       unique() %>%
                       length(),
                     edges = unlist(CLUe.network.human) %>%
                       length()) 
CLUe.network.mouse <- PhosphoSite.mouse
CLUe.size.mouse <- c(tool = "CLUe.mouse",
                     kinases = unique(names(CLUe.network.mouse)) %>% 
                       length(),
                     kinases_5 = names(CLUe.network.mouse)[map(CLUe.network.mouse, length) >= 5] %>% 
                       unique() %>%
                       length(),
                     pps = unlist(CLUe.network.mouse) %>% 
                       unique() %>%
                       length(),
                     edges = unlist(CLUe.network.mouse) %>%
                       length()) 

knitr::kable(rbind(CLUe.size.human, CLUe.size.mouse))
```


### IKAP
IKAP also uses PPS+. Following the instructions on GitHub (https://github.com/marcel-mischnik/IKAP) this will be manually downloaded before running IKAP. 
```{r, message=FALSE}
PPS.plus <- read_tsv(file = "data/PPSp_20220830", skip = 2)
PPS.plus.human <- PPS.plus %>% 
  dplyr::filter(KIN_ORGANISM == "human" & SUB_ORGANISM == "human") %>%
  dplyr::select(KINASE, SUB_GENE, SUB_MOD_RSD)
PPS.plus.human <- PPS.plus.human %>% filter(!duplicated(PPS.plus.human))

IKAP.size <- c(tool = "IKAP",
               kinases = unique(PPS.plus.human$KINASE) %>% 
                 length(),
               kinases_5 = names(table(PPS.plus.human$KINASE))[table(PPS.plus.human$KINASE) >= 5] %>% 
                 unique() %>%
                 length(),
               pps = paste(PPS.plus.human$SUB_GENE, PPS.plus.human$SUB_MOD_RSD, sep = "_") %>% 
                 unique() %>%
                 length(),
               edges = nrow(PPS.plus.human)) 

knitr::kable(rbind(CLUe.size.human, IKAP.size))

```

### KinasePA

KinasePA also uses the annotations from PhosphoSite Plus
```{r}
data(PhosphoSite)

KinasePA.network.human <- PhosphoSite.human
KinasePA.size <- c(tool = "KinasePA",
                   kinases = unique(names(KinasePA.network.human)) %>% 
                     length(),
                   kinases_5 = names(KinasePA.network.human)[map(KinasePA.network.human, length) >= 5] %>% 
                     unique() %>%
                     length(),
                   pps = unlist(KinasePA.network.human) %>% 
                     unique() %>%
                     length(),
                   edges = unlist(KinasePA.network.human) %>%
                     length()) 

knitr::kable(rbind(CLUe.size.human, IKAP.size, KinasePA.size))
```

### KARP
No source code available. In the publication they also use PhosphoSitePlus.
```{r}
KARP.size <- IKAP.size #(PhosphoSitePlus from 2022-08-30)
KARP.size["tool"] <- "KARP"

knitr::kable(rbind(CLUe.size.human, IKAP.size, KinasePA.size, KARP.size))
```

## KSEA App

```{r}
KSEA.network <- KSEAapp::KSData
KSEA.network.filtered <- KSEA.network %>% filter(networkin_score >= 5)

KSEA.size <- c(tool = "KSEA App",
               kinases = unique(KSEA.network.filtered$KINASE) %>% 
                 length(),
               kinases_5 = names(table(KSEA.network.filtered$KINASE))[table(KSEA.network.filtered$KINASE) >= 5] %>% 
                 unique() %>%
                 length(),
               pps = paste(KSEA.network.filtered$SUB_GENE, KSEA.network.filtered$SUB_MOD_RSD, sep = "_") %>% 
                 unique() %>%
                 length(),
               edges = nrow(KSEA.network.filtered)) 

knitr::kable(rbind(CLUe.size.human, IKAP.size, KinasePA.size, KARP.size, KSEA.size))
```
### INKA
Kinases from KinBase, activation loop from Phomics toolbox, PhosphoSitePlus, NetworKIN (>= 2). We only count kinases that are listed in the kinome + are listed either in PPS+/NetworKIN. Kinases who are only presented in one of them will get a final schore of 0.

```{r}
load("INKA/Manning.Kinases_20Jan2017.Rdata")
load("INKA/PSP_KSR_human_03Jul2016.Rdata")
load("INKA/TOP_NWK_nwk_proteome_unprot_ref_2014.Rdata")

kinome <- Kinases
phomics <- read_tsv("INKA/phomics_global_output.txt")
PSP <- PSP_KSR_human
NWK <- TOP_NWK
NWK_filtered <- TOP_NWK %>% filter(NetworKIN.score >= 2)

kinases_PSP_5 <- names(table(PSP$KINASE))[table(PSP$KINASE) >= 5]
kinases_NKW_5 <- names(table(NWK_filtered$Kinase))[table(NWK_filtered$Kinase) >= 5]

network <- data.frame(kin = c(PSP$KINASE, NWK_filtered$Kinase),
                      PSP = c(paste(PSP$SUB_GENE, PSP$SUB_MOD_RSD, sep = "_"),
                              paste(NWK_filtered$Target.description, NWK_filtered$Position, sep = "_")))
network <- network[!duplicated(network),]

INKA.size <- c(tool = "INKA",
               kinases = kinome %>% filter(in_PSP > 0 | in_NWK > 0) %>% 
                 nrow(),
               kinases_5 = c(kinases_PSP_5, kinases_NKW_5) %>% 
                 unique() %>%
                 length(),
               pps = c(paste(PSP$SUB_GENE, PSP$SUB_MOD_RSD, sep = "_"), 
                       paste(NWK_filtered$Target.description, NWK_filtered$Position, sep = "_")) %>% 
                 unique() %>%
                 length(),
               edges = nrow(network)) 

knitr::kable(rbind(CLUe.size.human, IKAP.size, KinasePA.size, KARP.size, KSEA.size, INKA.size))

```


### PTM-SEA
PTMsigDB for PTM-SEA was extracted from the package (https://github.com/broadinstitute/ssGSEA2.0/tree/master/db)

```{r}
PTMsigDB <- read.gmt("data/ptm.sig.db.all.uniprot.human.v1.9.0.gmt")
PTMsigDB.kinase <- PTMsigDB[str_detect(names(PTMsigDB), "KINASE")]

PTMsigDB.size <- c(tool = "PTMsigDB",
                   kinases = length(unique(names(PTMsigDB.kinase))),
                   kinases_5 = names(PTMsigDB.kinase)[map(PTMsigDB.kinase, length) >= 5] %>%
                     unique() %>%
                     length(),
                   pps = unlist(PTMsigDB.kinase) %>% 
                     unique() %>%
                     length(),
                   edges = unlist(PTMsigDB.kinase) %>%
                     length()) 

knitr::kable(rbind(CLUe.size.human, IKAP.size, KinasePA.size, KARP.size, KSEA.size, INKA.size, PTMsigDB.size))
```
### KEA3
PhosD.All, PTMsigDB, Cheng.KSI, BioGRID, mentha, prePPI, MINT, HIPPIE, Cheng.PPI, STRING.bind
KEA 3 libraries were downloaded from here: https://maayanlab.cloud/kea3/templates/libraries.jsp.
```{r}
library_files_KEA3 <- list.files("data/KEA3", full.names = T)
KEA3_libraries <- map(library_files_KEA3, read.gmt)

kinases_KEA3 <- map(KEA3_libraries, function(library){
  kinases <- lapply(str_split(names(library), "_"), "[[", 1) %>% unlist()
}) %>% unlist()

kinases_5_KEA3 <- map(KEA3_libraries, function(library){
  library_5 <- library[map(library, length) >= 5]
  kinases <- lapply(str_split(names(library_5), "_"), "[[", 1) %>% unlist()
}) %>% unlist()

edges_KEA3 <- map(KEA3_libraries, function(library){
  names(library) <- lapply(str_split(names(library), "_"), "[[", 1) %>% unlist()
  edges <- map(names(library), function(kinase){
    paste(kinase, library[[kinase]], sep = "_")
  }) %>% unlist()
}) %>% unlist()

KEA3.size <- c(tool = "KEA3",
               kinases = length(unique(kinases_KEA3)),
               kinases_5 = length(unique(kinases_5_KEA3)),
               pps = length(unique(unlist(KEA3_libraries))),
               edges = unique(edges_KEA3) %>%
                     length()) 

knitr::kable(rbind(CLUe.size.human, IKAP.size, KinasePA.size, KARP.size, KSEA.size, INKA.size, PTMsigDB.size, KEA3.size))
```



### RoKAI
RoKAI combines information from PhosphositePlus, PTMcode and STRING. The final network was extracted from here: https://github.com/serhan-yilmaz/RoKAI/tree/master/data.
```{r}
network_size_rokai <- read_csv("code/RoKAI-master/data/nerwork_size_rokai.csv", 
    col_names = FALSE)
colnames(network_size_rokai) <- c("n_KSedges","n_KKedges", "n_SSedges_coec", "n_SSedges_sd", "n_edges", "n_pps", "n_kin")

RoKAI.size <- c(tool = "RoKAI",
               kinases = network_size_rokai$n_kin,
               kinases_5 = NA,
               pps = network_size_rokai$n_pps,
               edges = network_size_rokai$n_edges) 

knitr::kable(rbind(CLUe.size.human, IKAP.size, KinasePA.size, KARP.size, KSEA.size, INKA.size, PTMsigDB.size, RoKAI.size, KEA3.size))
```

## Plot coverage
```{r, coverage}
size_networks <- data.frame(rbind(CLUe.size.human, IKAP.size, KinasePA.size, KARP.size, KSEA.size, INKA.size, PTMsigDB.size, KEA3.size, RoKAI.size))
size_networks$kinases <- as.numeric(size_networks$kinases)
size_networks$kinases_5 <- as.numeric(size_networks$kinases_5)
size_networks$pps <- as.numeric(size_networks$pps)
size_networks$edges <- as.numeric(size_networks$edges)

# change structure of df to use ggplot
size_networks_long <- size_networks %>% 
  pivot_longer(!tool,
               names_to = "type",
               values_to = "value") %>% 
  arrange(desc(value))
size_networks_long[is.na(size_networks_long)] <- 1

size_networks_long$tool <- factor(size_networks_long$tool, levels = unique(size_networks_long$tool))

size_networks_kin <- size_networks_long %>% filter(type %in% c("kinases", "kinases_5"))

size_networks_pps <- size_networks_long %>% filter(type %in% c("pps", "edges"))


pps_p <- ggplot(size_networks_pps %>% filter(type == "pps")) + 
  aes(x = tool, y = value) +
  geom_bar(stat="identity", color="black", position=position_dodge(), fill = "#47AD7A", width=0.7)+
  scale_y_cut(breaks=c(21000), which=c(1), scales=c(0.5)) +
  theme_minimal() + xlab("") + ylab("") + 
  ggtitle("unique targets") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        text = element_text(size = 10))
  

edges_p <- ggplot(size_networks_pps %>% filter(type == "edges")) + 
  aes(x = tool, y = value) +
  geom_bar(stat="identity", color="black", position=position_dodge(), fill = "#AD477A", width=0.7)+
  scale_y_cut(breaks=c(18000), which=c(1), scales=c(0.5)) +
  theme_minimal() + xlab("") + ylab("") + 
  ggtitle("kinase-target links") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        text = element_text(size = 10))

kin_p <- ggplot(data=size_networks_kin, aes(x=tool, y=value, fill=type)) +
  geom_bar(stat="identity",color="black", position=position_dodge(), width=0.7) + 
  scale_fill_manual(labels = c("all kinases", "kinases with \nat least 5 targets"), values=c('#477AA3','#97CAF3')) +
  theme_minimal() + xlab("") + ylab("") + guides(fill=guide_legend(title="")) + 
  ggtitle("unique kinases") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        text = element_text(size = 10),
        legend.position = "bottom",
        legend.key.size = unit(0.5, 'cm')) + 
  scale_y_continuous(expand = c(0, 0))

# adjusting margins manually to align plots
merged_p <- (edges_p / pps_p) 
leg <- cowplot::get_legend(kin_p)
kin_adj_p <- kin_p + theme(plot.margin=unit(c(0.4,0.6,0.6,0.2), "cm"), 
                           plot.title = element_text(margin=margin(0,0,10,0)),
                           legend.position = "none")

ggpubr::ggarrange(merged_p,kin_adj_p, NULL, leg, nrow = 2, ncol = 2, widths = c(1, 1.2), heights = c(3,0.3))
pdf("output/figures/coverage.pdf", width = 6.25, height = 6)
ggpubr::ggarrange(merged_p,kin_adj_p, NULL, leg, nrow = 2, ncol = 2, widths = c(1, 1.2), heights = c(3,0.3))
dev.off()

```

## Databases
Here we will list the raw data bases used in the methods (as of 2022-08-30)
- PhosphoSitePlus
- NetworKin
- PTMcode
- STRING


### PhosphoSitePlus
```{r}
PPS.plus <- read_tsv(file = "data/PPSp_20220830", skip = 2)
```

### NetworKin
```{r}

```

